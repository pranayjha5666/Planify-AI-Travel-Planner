import 'dart:convert';
import 'package:ai_travel_planner/Components/Screen/Create_Trip/Pages/Services/database.dart';
import 'package:ai_travel_planner/Components/Screen/Home_Page/home_page.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:flutter/material.dart';
import 'package:flutter_dotenv/flutter_dotenv.dart';
import 'package:google_generative_ai/google_generative_ai.dart';
import 'package:lottie/lottie.dart';
import 'package:provider/provider.dart';
import '../../../../Provider/CreateTripProvider.dart';

class GenerateTrip extends StatefulWidget {
  static const String routeName = "/create-trip/generate-trip";

  const GenerateTrip({super.key});

  @override
  State<GenerateTrip> createState() => _GenerateTripState();
}

class _GenerateTripState extends State<GenerateTrip> {
  bool isLoading = false;
  String? generatedResponse;

  @override
  void initState() {
    super.initState();
    WidgetsBinding.instance.addPostFrameCallback((_) => generateTravelPlan());
  }

  Future<void> generateTravelPlan() async {
    final tripData =
        Provider.of<TripProvider>(context, listen: false).tripData;
    final String prompt =
        "Generate Travel Plan for Location: ${tripData['name']}, for ${tripData['totalNoOfDays']} Days and ${tripData['totalNoOfDays'] - 1} Nights for ${tripData['travelOption']['title']} with a ${tripData['budget']['title']} budget. "
        "Include Flight details, Flight Price with Booking URL, Hotels options list with HotelName, Hotel address, Price, hotel image URL, geo-coordinates, rating, descriptions. "
        "Also, include Places to visit nearby with placeName, Place Details, Place Image URL, geo-coordinates, ticket Pricing, Time to travel each of the locations for ${tripData['totalNoOfDays']} days and ${tripData['totalNoOfDays'] - 1} nights with each day plan, best time to visit in JSON.";

    try {
      setState(() {
        isLoading = true;
      });

      String apiKey = dotenv.env["Geminiapikey"] ?? "";
      final model = GenerativeModel(
        model: 'gemini-2.0-flash-exp',
        apiKey: apiKey,
        generationConfig: GenerationConfig(
          temperature: 1,
          topK: 40,
          topP: 0.95,
          maxOutputTokens: 8192,
          responseMimeType: 'application/json',
        ),
      );


      final chat = model.startChat(history: [
        Content.multi([
          TextPart('yes this is perfect Generate a comprehensive travel plan for the destination: Mumbai, covering 3 days and 2 nights for Just Me with a Luxery budget.\n\n\nHotel Options:\nList multiple hotel options with:\nHotel Name\nAddress\nPrice Range\nBooking URL\nHotel Image URL\nGeo-coordinates\nRating\nBrief description\nMust-Visit Places (Never Miss Out List)\nHighlight at least 5 and at most 10 must-visit places.\nFor each place, provide:\nName\nDetailed description\nRich historical background\nGeo-coordinates\nRating\nNearby Attractions & Daily Itinerary\nList nearby attractions, including:\nPlace Name\nPlace Details\nImage URL\nGeo-coordinates\nTicket Pricing\nEstimated travel time between locations\nStructure a detailed day-wise itinerary for 3 days and 2 nights.\nBest Time to Visit\nProvide insights on the best season and time of day to visit based on weather, crowd levels, and local events.\nFormat the output in structured JSON for easy parsing.\n\n\nFor eg\nthe formate or the json must be \n{\nbudget:"Luxury",\nduration:"2 Days, 1 Night",\nhotelOptions:[\n{address:"Near Kumarghat Bus Stand, Ambassa, Tripura, 799280, India",amenities["Free Wifi","Restaurant","Air conditioning"],checkin:"1:00 PM",checkout:"12:00 PM",description:"A comfortable guest house offering well-appointed rooms and essential amenities.",geoCoordinates{latitude:23.8751,longitude:91.864},hotelName:"Hotel Royal Guest House",price:"INR 5000 - INR 8000 per night",rating:4},\n{address:"Near Hospital Road, Ambassa, Tripura, 799280, India",amenities["Free Wifi","Restaurant","Air conditioning"],checkin:"1:00 PM",checkout:"12:00 PM",description:"A well-maintained hotel with good hospitality and basic comfort.",geoCoordinates{latitude:23.8814,longitude:91.865},hotelName:"Hotel Gouri",price:"INR 4000 - INR 7000 per night",rating:3.8},\n],\nitinerary:{\nday1:{\nbestTimeToVisit:"October - March",\nplan:[{activity:"Arrive at Agartala Airport & Transfer to Ambassa",cost:"INR 2000 - 3000 for taxi",details:"Arrive at Agartala Airport, complete necessary formalities, and take a pre-booked private car transfer to Ambassa. Check into the hotel and freshen up.",placeDetails:"",time:"10:00 AM",travelTime:"2-3 hours by car"},{activity:"Lunch at a Local Restaurant",cost:"INR 500-INR 1000",details:"Enjoy a traditional Tripura meal at a local restaurant. Try some local delicacies.",placeDetails:",time:"1:00 PM"},{activity:"Visit Unakoti Hill",cost:"INR 2000 - 3000 for taxi",details:"Explore ancient rock carvings and murals depicting Hindu deities, a unique archaeological site.",placeDetails:"",time:"2:30 PM",travelTime:"2-3 hours from Ambassa"}],\ntheme:"Nature & Local Immersion"},\nday2:{\nbestTimeToVisit:"October - March",\nplan:[{activity:"Breakfast at Hotel",details:"Start your day with a leisurely breakfast at the hotel",placeDetails:"",time:"9:00 AM"},{activity:"Visit Pilak",details:"Explore archaeological remnants of Hindu and Buddhist sculptures, reflecting the historical diversity of the region.",placeDetails:",time:"10:00 AM",travelTime:"4 hours from Ambassa"}],\ntheme:"Cultural Exploration and Departure"},\n},\nlocation:"Ambassa, India",\ntravelers:"Solo",\ntripTitle:"Luxury Solo Trip to Ambassa: 2 Days & 1 Night",\n"mustVisitPlaces": [\n    {\n      "name": "Gateway of India",\n      "description": "An iconic arch monument built during the British Raj, overlooking the Arabian Sea. A symbol of Mumbai and a popular meeting point.",\n      "historicalBackground": "Built to commemorate the visit of King George V and Queen Mary to India in 1911. Served as the ceremonial entrance to India for British Viceroys and Governors.",\n      "geoCoordinates": { "latitude": 18.9220, "longitude": 72.8347 },\n      "rating": 4.7,\n       "nearbyAttractions": [\n            {\n              "name": "Elephanta Caves",\n              "placeDetails": "Ancient cave temples on Elephanta Island, featuring rock-cut architecture dedicated to Lord Shiva.",\n              "imageURL": "https://whc.unesco.org/uploads/thumbs/site_0244_0005-750-750-20120209164940.jpg",\n              "geoCoordinates": { "latitude": 18.9638, "longitude": 72.9318 },\n               "ticketPricing": "₹40 per person for Indians, ₹600 for foreigners, Ferry charges apply separately.",\n               "travelTime": "Approx. 1 hour by ferry from Gateway of India"\n             },\n          {\n              "name":"Taj Mahal Palace Hotel",\n              "placeDetails": "An iconic heritage hotel, symbol of Mumbai. The hotel is known for its stunning architecture and luxury.",\n              "imageURL": "https://res.cloudinary.com/tajhotels/image/upload/f_auto,q_auto,fl_progressive/v1637659153/TajHotels/New-Website/Desktop-Image-Gallery/The_Taj_Mahal_Palace_Mumbai_Exterior_Night_View.jpg",\n             "geoCoordinates": {"latitude": 18.9220, "longitude": 72.8347},\n             "ticketPricing":"N/A",\n             "travelTime": "Adjacent to Gateway of India"\n          }\n       ]\n    },\n     {\n      "name": "Chhatrapati Shivaji Maharaj Terminus (CST)",\n      "description": "A UNESCO World Heritage Site, this is a stunning example of Victorian Gothic architecture. A bustling railway station and a historical landmark.",\n      "historicalBackground": "Originally named Victoria Terminus, built to commemorate Queen Victoria\'s Golden Jubilee. Designed by British architect Frederick William Stevens and completed in 1887.",\n      "geoCoordinates": { "latitude": 18.9402, "longitude": 72.8344 },\n      "rating": 4.6,\n      "nearbyAttractions": [\n        {\n            "name": "Crawford Market",\n            "placeDetails":"A vibrant and bustling market for fresh produce, spices, and everyday goods, also known as Mahatma Jyotiba Phule Mandai",\n            "imageURL": "https://www.hindustantimes.com/ht-img/img/2023/10/08/1600x900/crawford_market_1696789131870_1696789141938.jpg",\n             "geoCoordinates": {"latitude": 18.9461, "longitude": 72.8330},\n             "ticketPricing":"N/A",\n            "travelTime":"Approx. 10-15 minutes walk from CST"\n        }\n      ]\n    },\n    {\n      "name": "Marine Drive",\n      "description": "A scenic 3.6-kilometer-long promenade along the Arabian Sea, also known as the \'Queen\'s Necklace\'. Offers beautiful sunset views and a relaxing walk.",\n      "historicalBackground": "Built as a coastal road in the 1920s. The curve of the promenade at night resembles a necklace of lights, hence the name.",\n      "geoCoordinates": { "latitude": 18.9460, "longitude": 72.8170 },\n      "rating": 4.5,\n      "nearbyAttractions": [\n        {\n            "name": "Girgaum Chowpatty",\n            "placeDetails": "A popular beach known for street food stalls, and a festive atmosphere, especially during Ganesh Chaturthi.",\n            "imageURL": "https://static.toiimg.com/thumb/msid-95601074,width-1280,height-720,resizemode-4/95601074.jpg",\n            "geoCoordinates":{"latitude": 18.9468, "longitude": 72.8135},\n            "ticketPricing":"N/A",\n            "travelTime": "Located near the northern end of Marine Drive"\n        }\n        ]\n     },\n      {\n       "name":"Shree Siddhivinayak Temple",\n       "description":"A prominent Hindu temple dedicated to Lord Ganesha.  Known for its magnificent architecture and spiritual ambiance, it attracts devotees and tourists alike.",\n       "historicalBackground":"Originally a small shrine in the 18th century.  It underwent significant expansion and renovation to become the grand temple it is today.",\n       "geoCoordinates":{"latitude": 19.0206, "longitude": 72.8396},\n       "rating": 4.6,\n       "nearbyAttractions": [\n        {\n            "name": "Haji Ali Dargah",\n             "placeDetails": "A mosque and dargah located on an islet off the coast of Worli. Accessible by a walkway during low tide.",\n             "imageURL": "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Haji_Ali_Dargah_Mumbai_%2821984341554%29.jpg/800px-Haji_Ali_Dargah_Mumbai_%2821984341554%29.jpg",\n             "geoCoordinates":{"latitude":18.9844, "longitude": 72.8113},\n             "ticketPricing":"N/A",\n            "travelTime":"Approx. 20-30 mins by taxi from Siddhivinayak Temple"\n         }\n       ]\n      },\n      {\n      "name": "Bandra-Worli Sea Link",\n      "description": "A cable-stayed bridge connecting Bandra and Worli. An engineering marvel, offering stunning views of the city skyline and Arabian Sea.",\n      "historicalBackground": "Officially known as the Rajiv Gandhi Sea Link. Opened in 2009 to ease traffic congestion between the city\'s western suburbs and south Mumbai.",\n      "geoCoordinates": { "latitude": 19.0321, "longitude": 72.8210 },\n      "rating": 4.7,\n      "nearbyAttractions": [\n          {\n            "name": "Bandra Fort (Castella de Aguada)",\n            "placeDetails":"A historical fort offering panoramic views of the Arabian Sea and the Mumbai skyline.",\n           "imageURL": "https://upload.wikimedia.org/wikipedia/commons/thumb/2/24/Bandra_Fort_Mumbai.JPG/800px-Bandra_Fort_Mumbai.JPG",\n            "geoCoordinates": {"latitude": 19.0448, "longitude": 72.8133},\n            "ticketPricing":"N/A",\n            "travelTime": "Approx. 15-20 mins from Bandra-Worli Sea Link"\n          }\n       ]\n    }\n  ],\n}\n\nI want this type of json formate\n\nin mustVisitPlaces add a long descriptions also\n\n\n\n\nthe key value of the mustVisitPlaces list must be same everytime \ninfact key value of all the whole json and list and map every key value is same everytime \nand\nthe ticketPricing in mustVisitPlaces  must be integer if it is the accurate figure else give approximate like this 40-80 like this \nticketPricing response is in the integer formate  if no cost write 0\n'),
        ]),
        Content.model([
          TextPart('```json\n{\n  "budget": "Luxury",\n  "duration": "3 Days, 2 Nights",\n  "hotelOptions": [\n    {\n      "hotelName": "The Taj Mahal Palace",\n      "address": "Apollo Bunder, Colaba, Mumbai, Maharashtra 400001",\n      "priceRange": "INR 30000 - INR 80000 per night",\n       "bookingURL": "https://www.tajhotels.com/en-in/taj/taj-mahal-palace-mumbai/",\n      "hotelImageURL": "https://res.cloudinary.com/tajhotels/image/upload/f_auto,q_auto,fl_progressive/v1637659153/TajHotels/New-Website/Desktop-Image-Gallery/The_Taj_Mahal_Palace_Mumbai_Exterior_Night_View.jpg",\n      "geoCoordinates": { "latitude": 18.9220, "longitude": 72.8347 },\n      "rating": 4.8,\n      "description": "An iconic luxury hotel with opulent rooms, world-class dining, and stunning views of the Arabian Sea. A landmark in Mumbai."\n    },\n    {\n      "hotelName": "The Oberoi Mumbai",\n      "address": "Nariman Point, Mumbai, Maharashtra 400021",\n      "priceRange": "INR 25000 - INR 70000 per night",\n      "bookingURL": "https://www.oberoihotels.com/hotels-in-mumbai/",\n      "hotelImageURL": "https://www.oberoihotels.com/-/media/oberoi-hotels/mumbai/images/exterior/mumbai-exterior.jpg",\n      "geoCoordinates": { "latitude": 18.9291, "longitude": 72.8233 },\n      "rating": 4.7,\n      "description": "A sophisticated luxury hotel known for its exceptional service, elegant rooms, and fine-dining experiences, overlooking the Arabian Sea."\n    },\n    {\n      "hotelName": "Four Seasons Hotel Mumbai",\n      "address": "1/136, Dr E Moses Rd, Worli, Mumbai, Maharashtra 400018",\n       "priceRange": "INR 20000 - INR 60000 per night",\n      "bookingURL":"https://www.fourseasons.com/mumbai/",\n      "hotelImageURL": "https://dynamic-media-cdn.tripadvisor.com/media/photo-o/1c/85/65/67/four-seasons-hotel-mumbai.jpg?w=700&h=-1&s=1",\n     "geoCoordinates": { "latitude": 19.0125, "longitude": 72.8239 },\n       "rating": 4.6,\n       "description":"A modern luxury hotel offering panoramic city views, stylish rooms, and a range of dining and wellness options in the heart of Worli."\n    },\n    {\n    "hotelName":"The St. Regis Mumbai",\n     "address":"462, Senapati Bapat Marg, Lower Parel, Mumbai, Maharashtra 400013",\n      "priceRange":"INR 18000 - INR 55000 per night",\n       "bookingURL":"https://www.marriott.com/en-us/hotels/bomxr-the-st-regis-mumbai/overview/",\n      "hotelImageURL":"https://cache.marriott.com/content/dam/marriott-renditions/BOMXR/bomxr-exterior-0019-hor-wide.jpg?output-quality=70&interpolation=progressive-bicubic",\n     "geoCoordinates":{"latitude":19.0094, "longitude":72.8363},\n     "rating":4.7,\n     "description":"A sophisticated luxury hotel with exquisite rooms, fine dining, and a range of amenities in the vibrant Lower Parel area."\n    }\n  ],\n  "itinerary": {\n    "day1": {\n      "bestTimeToVisit": "October - March",\n      "plan": [\n        {\n          "activity": "Arrival and Check-in",\n          "cost": "INR 5000 - INR 10000 (for luxury car)",\n          "details": "Arrive at Mumbai International Airport (BOM). Transfer to your chosen luxury hotel. Check-in and freshen up.",\n          "placeDetails": "",\n          "time": "10:00 AM",\n           "travelTime":"1 hour from airport"\n        },\n        {\n          "activity": "Gateway of India & Elephanta Caves",\n          "cost": "INR 1000 - INR 3000 (including ferry and entrance)",\n          "details":"Visit the iconic Gateway of India and take a ferry to Elephanta Island. Explore the ancient rock-cut cave temples. Enjoy lunch at one of the restaurants near Gateway of India",\n          "placeDetails": "",\n          "time": "1:00 PM",\n          "travelTime":"Approx 1 hour from hotel"\n        },\n        {\n           "activity": "Taj Mahal Palace Hotel & Colaba Causeway",\n           "cost":"INR 0 (window shopping)",\n           "details": "Explore the grand architecture of Taj Mahal Palace Hotel, have high tea there and later stroll through Colaba Causeway for some shopping. ",\n            "placeDetails":"",\n           "time":"5:00 PM",\n           "travelTime":"Adjacent to Gateway of India"\n        },\n          {\n          "activity": "Dinner at a Fine-Dining Restaurant",\n          "cost": "INR 5000 - INR 8000",\n          "details": "Enjoy a gourmet dinner at one of Mumbai\'s top fine-dining restaurants.",\n           "placeDetails":"",\n          "time":"8:30 PM"\n         }\n      ],\n      "theme": "Historical Exploration and Luxury"\n    },\n    "day2": {\n      "bestTimeToVisit": "October - March",\n      "plan": [\n        {\n          "activity": "Breakfast at the Hotel",\n          "details": "Start your day with a leisurely breakfast at the hotel.",\n          "placeDetails": "",\n          "time": "9:00 AM"\n        },\n       {\n          "activity": "Chhatrapati Shivaji Maharaj Terminus (CST) & Crawford Market",\n          "cost":"INR 500 - 1000 for taxi",\n           "details": "Visit the UNESCO World Heritage Site, CST and explore the historical architecture of the building . Explore the nearby Crawford Market for a taste of local life.",\n           "placeDetails":"",\n           "time":"10:30 AM",\n           "travelTime":"Approx 30 mins from hotel"\n       },\n       {\n          "activity": "Shree Siddhivinayak Temple",\n          "cost": "INR 0 (donations as per wish)",\n          "details":"Visit the famous Shree Siddhivinayak Temple and experience the spiritual ambiance.",\n          "placeDetails":"",\n          "time":"1:30 PM",\n           "travelTime":"Approx 30-40 minutes from CST"\n        },\n        {\n           "activity":"Lunch at Local Restaurant",\n           "cost":"INR 2000-INR 3000",\n            "details":"Have a delicious local lunch in the vicinity.",\n             "placeDetails":"",\n            "time":"3:00 PM"\n        },\n        {\n          "activity": "Marine Drive & Girgaum Chowpatty",\n          "cost": "INR 0",\n          "details": "Enjoy a scenic walk along Marine Drive, witness the sunset and then stroll through the Girgaum Chowpatty",\n          "placeDetails": "",\n          "time": "5:00 PM",\n           "travelTime":"20-30 mins from Siddhivinayak Temple"\n        },\n          {\n          "activity": "Dinner & Relaxation",\n          "cost": "INR 4000-7000",\n          "details": "Enjoy dinner at a restaurant of your choice, and relax at your hotel. Maybe enjoy some of the amenities of the hotel like the spa",\n          "placeDetails":"",\n          "time": "8:30 PM"\n        }\n      ],\n      "theme": "Cultural Immersion & City Views"\n    },\n        "day3": {\n      "bestTimeToVisit": "October - March",\n      "plan": [\n           {\n             "activity": "Breakfast at Hotel",\n             "details": "Enjoy breakfast at the hotel and relax.",\n             "placeDetails":"",\n             "time":"9:00 AM"\n         },\n        {\n          "activity": "Bandra-Worli Sea Link & Bandra Fort",\n          "cost":"INR 500-1000 for taxi",\n          "details": "Drive across the Bandra-Worli Sea Link and explore the historical Bandra Fort. Enjoy the views of the Arabian Sea.",\n          "placeDetails": "",\n          "time": "11:00 AM",\n          "travelTime":"40-50 mins from hotel"\n        },\n           {\n          "activity": "Shopping at Linking Road/ Bandra",\n          "cost":"INR 0 (depends on your spending)",\n          "details":"Enjoy the street shopping experience at the Linking Road area in Bandra or explore some of the showrooms",\n          "placeDetails":"",\n          "time":"1:00 PM",\n            "travelTime":"Approx 10-15 mins from Bandra Fort"\n        },\n         {\n          "activity": "Lunch at a Restaurant in Bandra",\n          "cost": "INR 3000 - INR 5000",\n           "details": "Enjoy lunch at a restaurant in the Bandra area.",\n           "placeDetails":"",\n          "time": "3:00 PM"\n        },\n        {\n          "activity": "Departure",\n          "cost": "INR 5000 - INR 10000 (for luxury car)",\n          "details": "Transfer to Mumbai International Airport for your departure.",\n          "placeDetails": "",\n           "time": "6:00 PM",\n           "travelTime":"Approx 1 hour from Bandra"\n        }\n      ],\n      "theme": "Modern Marvels and Departure"\n    }\n  },\n  "location": "Mumbai, India",\n  "travelers": "Solo",\n  "tripTitle": "Luxury Solo Trip to Mumbai: 3 Days & 2 Nights",\n  "mustVisitPlaces": [\n    {\n      "name": "Gateway of India",\n      "description": "An iconic arch monument built during the British Raj, overlooking the Arabian Sea. A symbol of Mumbai and a popular meeting point. The gateway was built to commemorate the visit of King George V and Queen Mary to India in 1911. It served as a ceremonial entrance to India for British Viceroys and Governors. This imposing structure is crafted from yellow basalt and is a blend of Indo-Saracenic architecture, incorporating elements of Hindu and Islamic design.",\n      "historicalBackground": "Built to commemorate the visit of King George V and Queen Mary to India in 1911. Served as the ceremonial entrance to India for British Viceroys and Governors.",\n      "geoCoordinates": { "latitude": 18.9220, "longitude": 72.8347 },\n      "rating": 4.7,\n       "nearbyAttractions": [\n            {\n              "name": "Elephanta Caves",\n              "placeDetails": "Ancient cave temples on Elephanta Island, featuring rock-cut architecture dedicated to Lord Shiva. These caves, a UNESCO World Heritage site, showcase a collection of rock art linked to the cult of Shiva and are a blend of Hindu and Buddhist religious practices and ideals.The island is about 10 kilometers east of Mumbai and can be reached by ferry.",\n              "imageURL": "https://whc.unesco.org/uploads/thumbs/site_0244_0005-750-750-20120209164940.jpg",\n              "geoCoordinates": { "latitude": 18.9638, "longitude": 72.9318 },\n               "ticketPricing": 40,\n               "travelTime": "Approx. 1 hour by ferry from Gateway of India"\n             },\n          {\n              "name":"Taj Mahal Palace Hotel",\n              "placeDetails": "An iconic heritage hotel, symbol of Mumbai. The hotel is known for its stunning architecture and luxury. It was built during the British Raj and was one of the first hotels in India with electricity.The hotel’s majestic architecture blends Indo-Saracenic, Florentine, and Moorish styles, making it a landmark in the city.",\n              "imageURL": "https://res.cloudinary.com/tajhotels/image/upload/f_auto,q_auto,fl_progressive/v1637659153/TajHotels/New-Website/Desktop-Image-Gallery/The_Taj_Mahal_Palace_Mumbai_Exterior_Night_View.jpg",\n             "geoCoordinates": {"latitude": 18.9220, "longitude": 72.8347},\n             "ticketPricing":0,\n             "travelTime": "Adjacent to Gateway of India"\n          }\n       ]\n    },\n    {\n      "name": "Chhatrapati Shivaji Maharaj Terminus (CST)",\n      "description": "A UNESCO World Heritage Site, this is a stunning example of Victorian Gothic architecture. A bustling railway station and a historical landmark. Originally named Victoria Terminus, the railway station is known for its elaborate facade, adorned with gargoyles, stained glass, and intricate carvings. It was built as a symbol of Mumbai\'s prosperity during the British Raj. It continues to serve as a major transportation hub of Mumbai.",\n      "historicalBackground": "Originally named Victoria Terminus, built to commemorate Queen Victoria\'s Golden Jubilee. Designed by British architect Frederick William Stevens and completed in 1887.",\n      "geoCoordinates": { "latitude": 18.9402, "longitude": 72.8344 },\n      "rating": 4.6,\n      "nearbyAttractions": [\n        {\n            "name": "Crawford Market",\n            "placeDetails":"A vibrant and bustling market for fresh produce, spices, and everyday goods, also known as Mahatma Jyotiba Phule Mandai. This market built in 1869 is a blend of British colonial and Indian architecture and is known for its bustling atmosphere. It offers a wide variety of items and is a great place to experience the local culture.",\n            "imageURL": "https://www.hindustantimes.com/ht-img/img/2023/10/08/1600x900/crawford_market_1696789131870_1696789141938.jpg",\n             "geoCoordinates": {"latitude": 18.9461, "longitude": 72.8330},\n             "ticketPricing":0,\n            "travelTime":"Approx. 10-15 minutes walk from CST"\n        }\n      ]\n    },\n    {\n      "name": "Marine Drive",\n      "description": "A scenic 3.6-kilometer-long promenade along the Arabian Sea, also known as the \'Queen\'s Necklace\'. Offers beautiful sunset views and a relaxing walk. Marine Drive is known for its iconic curved shape, which looks like a necklace of lights when lit up at night. It is a popular place for locals and tourists to enjoy the fresh sea breeze and relax. The promenade is an integral part of Mumbai\'s identity and has also been a location for several movie scenes.",\n      "historicalBackground": "Built as a coastal road in the 1920s. The curve of the promenade at night resembles a necklace of lights, hence the name.",\n      "geoCoordinates": { "latitude": 18.9460, "longitude": 72.8170 },\n      "rating": 4.5,\n      "nearbyAttractions": [\n        {\n            "name": "Girgaum Chowpatty",\n            "placeDetails": "A popular beach known for street food stalls, and a festive atmosphere, especially during Ganesh Chaturthi.  Girgaum Chowpatty is a hub of activity. The beach is known for its lively street food stalls offering a variety of snacks, including Mumbai\'s famous chaat. The annual Ganesh Chaturthi festival celebrations are held here, when massive idols of Lord Ganesha are immersed in the sea. The beach is a great place to experience the vibrant spirit of Mumbai.",\n            "imageURL": "https://static.toiimg.com/thumb/msid-95601074,width-1280,height-720,resizemode-4/95601074.jpg",\n            "geoCoordinates":{"latitude": 18.9468, "longitude": 72.8135},\n            "ticketPricing":0,\n            "travelTime": "Located near the northern end of Marine Drive"\n        }\n        ]\n     },\n      {\n       "name":"Shree Siddhivinayak Temple",\n       "description":"A prominent Hindu temple dedicated to Lord Ganesha. Known for its magnificent architecture and spiritual ambiance, it attracts devotees and tourists alike. The original temple was built in the early 19th century and was renovated to the present grand structure. The temple\'s architecture is a mix of traditional Hindu and modern styles. It is known for its impressive gold-plated dome and the idol of Lord Ganesha, which is considered extremely sacred by devotees. The temple attracts a large number of visitors daily.",\n       "historicalBackground":"Originally a small shrine in the 18th century. It underwent significant expansion and renovation to become the grand temple it is today.",\n       "geoCoordinates":{"latitude": 19.0206, "longitude": 72.8396},\n       "rating": 4.6,\n       "nearbyAttractions": [\n        {\n            "name": "Haji Ali Dargah",\n             "placeDetails": "A mosque and dargah located on an islet off the coast of Worli. Accessible by a walkway during low tide. Built in the 15th century, it houses the tomb of Muslim Saint, Sayed Peer Haji Ali Shah Bukhari. It\'s known for its Indo-Islamic architecture and is an important pilgrimage site for Muslims. It is also a popular tourist attraction and known for its unique location, offering a serene view of the Arabian Sea.",\n             "imageURL": "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Haji_Ali_Dargah_Mumbai_%2821984341554%29.jpg/800px-Haji_Ali_Dargah_Mumbai_%2821984341554%29.jpg",\n             "geoCoordinates":{"latitude":18.9844, "longitude": 72.8113},\n             "ticketPricing":0,\n            "travelTime":"Approx. 20-30 mins by taxi from Siddhivinayak Temple"\n         }\n       ]\n      },\n      {\n      "name": "Bandra-Worli Sea Link",\n      "description": "A cable-stayed bridge connecting Bandra and Worli. An engineering marvel, offering stunning views of the city skyline and Arabian Sea. The sea link is officially known as the Rajiv Gandhi Sea Link. It\'s a modern engineering marvel and has eight lanes of road, and serves as a major artery for commuters in Mumbai. It is also a great place to get a view of the city\'s skyline, specially at night when the lights make the bridge glow.",\n      "historicalBackground": "Officially known as the Rajiv Gandhi Sea Link. Opened in 2009 to ease traffic congestion between the city\'s western suburbs and south Mumbai.",\n      "geoCoordinates": { "latitude": 19.0321, "longitude": 72.8210 },\n      "rating": 4.7,\n      "nearbyAttractions": [\n          {\n            "name": "Bandra Fort (Castella de Aguada)",\n            "placeDetails":"A historical fort offering panoramic views of the Arabian Sea and the Mumbai skyline. The fort was built by the Portuguese in the 17th century as a watchtower to guard the Mahim Bay. It is a popular spot for tourists and locals looking for some quiet time by the sea. The fort provides a great view of the Arabian sea and the Bandra-Worli Sea Link.",\n           "imageURL": "https://upload.wikimedia.org/wikipedia/commons/thumb/2/24/Bandra_Fort_Mumbai.JPG/800px-Bandra_Fort_Mumbai.JPG",\n            "geoCoordinates": {"latitude": 19.0448, "longitude": 72.8133},\n            "ticketPricing":0,\n            "travelTime": "Approx. 15-20 mins from Bandra-Worli Sea Link"\n          }\n       ]\n    }\n  ]\n}\n```'),
        ]),
      ]);
      final content = Content.text(prompt);

      final response = await chat.sendMessage(content);


      setState(() {
        isLoading = false;
        generatedResponse = response.text;
      });

      final tripres=jsonDecode(response.text!);
      String id = FirebaseAuth.instance.currentUser!.uid;
      Map<String,dynamic> addTripToDatabase={
        "aitripdetails":tripres,
        "usertripdetails":Provider.of<TripProvider>(context, listen: false).tripData
    };
      await DatabaseMethods().addDetailsToDatabase(addTripToDatabase, id);
      Navigator.pushNamedAndRemoveUntil(context, Home_Page.routeName,(route) => false,);

    } catch (e) {
      setState(() {
        isLoading = false;
      });
      print("Error generating travel plan: $e");
      Navigator.pushNamedAndRemoveUntil(context, Home_Page.routeName,(route) => false,);

    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        centerTitle: true,
        title: const Text('Generate Trip',style: TextStyle(
          fontSize: 30,
          fontFamily: 'Outfit',
          fontWeight: FontWeight.w600,
          color: Colors.black,
        ),),
      ),
      body: Padding(
        padding: const EdgeInsets.all(20.0),
        child: isLoading
            ? Center(
              child: Lottie.asset(
                        'assets/animations/tripgenerating.json',
                        height: 350,
                        reverse: true,
                        repeat: true,
                        fit: BoxFit.cover,
                      ),
            )
            : Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            const Text(
              "",
              style: TextStyle(
                fontSize: 24,
                fontWeight: FontWeight.bold,
              ),
            ),
            const SizedBox(height: 10),
          ],
        )

      ),
    );
  }
}
